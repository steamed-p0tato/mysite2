<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMD Radeon RX 7600 Setup Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Theme Typography --- */
        body {
            font-family: 'Times New Roman', Times, serif;
        }

        h1, h2, h3, h4 {
            font-weight: normal; /* Theme uses normal weight for headings */
        }

        /* --- Theme Button Style --- */
        .back-link {
            display: inline-block;
            text-decoration: none;
            color: #5d5d5d;
            border: 1px solid #888;
            padding: 8px 20px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            font-family: sans-serif; /* Contrast font for UI elements */
            margin-top: 1rem;
        }
        .back-link:hover {
            background-color: #5d5d5d;
            color: #f0efeb;
        }

        /* --- Custom Code Block Styling to match theme contrast --- */
        pre {
            background-color: #2d2d2d; /* Dark contrast for code */
            color: #f0efeb;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            border: 1px solid #dcdcdc;
        }

        code {
            font-family: 'Courier New', Courier, monospace;
        }
        
        /* Inline code styling */
        p code, li code {
            background-color: #e5e5e5;
            color: #333;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.9em;
        }
    </style>
</head>

<body class="bg-[#f0efeb] text-[#5d5d5d] min-h-screen p-4 sm:p-8">

    <main class="mx-auto bg-white p-8 sm:p-12 rounded-xl border border-[#dcdcdc] shadow-lg max-w-4xl w-full">
        
        <div class="mb-8">
            <a href="https://www.ariyanbasu.site" class="back-link">
                &larr; Go Back Home
            </a>
        </div>

        <header class="mb-10 text-center border-b border-[#dcdcdc] pb-8">
            <h1 class="text-3xl sm:text-4xl text-[#5d5d5d] mb-4">
                AMD Radeon RX 7600 (Navi 33)<br>PyTorch Setup on Ubuntu 25
            </h1>
            <p class="text-lg text-[#5d5d5d] italic">
                A guide to Native Docker, ROCm (HIP), and GFX Masquerading.
            </p>
        </header>

        <section class="mb-10">
            <p class="text-lg mb-4">
                This guide documents the successful setup of a local AI environment on Ubuntu 25 using <strong>Native Docker</strong> (not Docker Desktop) to run PyTorch with ROCm (HIP) acceleration on an RX 7600.
            </p>
            <div class="p-4 border border-[#888] rounded bg-[#f9f9f9]">
                <p class="m-0"><strong>Note:</strong> Since the RX 7600 (gfx1102) is not officially supported by PyTorch binaries (which target gfx1100/RX 7900), this setup uses a masquerading technique via Docker to force compatibility.</p>
            </div>
        </section>

        <section class="mb-10">
            <h2 class="text-2xl text-[#5d5d5d] mb-4 border-b border-[#dcdcdc] pb-2">1. Prerequisites & Host Setup</h2>
            
            <h3 class="text-xl mt-6 mb-2 underline decoration-[#dcdcdc]">A. Driver Verification (Ubuntu 25)</h3>
            <p class="mb-4">Ubuntu 25's kernel (6.10+) includes the necessary drivers by default. Verify your kernel has loaded the compute drivers:</p>
            <pre>ls -l /dev/kfd /dev/dri</pre>
            <p class="mb-4"><strong>Success:</strong> You see <code>/dev/kfd</code> and <code>/dev/dri/renderD128</code>.<br>
            <strong>Troubleshooting:</strong> If <code>/dev/kfd</code> is missing, run <code>sudo modprobe amdkfd</code>.</p>

            <h3 class="text-xl mt-6 mb-2 underline decoration-[#dcdcdc]">B. User Permissions</h3>
            <p class="mb-4">Your user must belong to the <code>render</code>, <code>video</code>, and <code>docker</code> groups.</p>
            <pre>sudo usermod -aG docker,video,render $USER</pre>
            <p class="mb-4">Log out and log back in (or reboot) to apply changes.</p>

            <h3 class="text-xl mt-6 mb-2 underline decoration-[#dcdcdc]">C. Docker Setup (Native)</h3>
            <p class="mb-4">Uninstall Docker Desktop if present (it blocks hardware passthrough) and install Native Docker.</p>
            <pre># Remove Docker Desktop
sudo apt-get remove docker-desktop
rm -r $HOME/.docker/desktop
mv ~/.docker ~/.docker_backup

# Install Native Engine
sudo apt update
sudo apt install docker.io docker-compose-v2 docker-buildx-plugin</pre>
        </section>

        <section class="mb-10">
            <h2 class="text-2xl text-[#5d5d5d] mb-4 border-b border-[#dcdcdc] pb-2">2. Project Configuration</h2>
            <p class="mb-4">Create a workspace:</p>
            <pre>mkdir -p ~/rocm-lab/workspace
cd ~/rocm-lab</pre>

            <h3 class="text-xl mt-6 mb-2">File 1: Dockerfile</h3>
            <p class="mb-2">This image extends the official ROCm PyTorch image and adds the <code>gfx1100</code> override.</p>
            <pre># Base image: Official ROCm 6.0 with PyTorch 2.1.1
FROM rocm/pytorch:rocm6.0_ubuntu22.04_py3.9_pytorch_2.1.1

# --- CRITICAL OVERRIDE ---
# Masquerade RX 7600 (gfx1102) as RX 7900 (gfx1100)
ENV HSA_OVERRIDE_GFX_VERSION=11.0.0

# Install system dependencies
RUN pip install --upgrade pip && \
    pip install transformers accelerate streamlit sentence-transformers pandas scikit-learn jupyterlab

# --- BITSANDBYTES FIX ---
# Required for loading 4-bit/8-bit LLMs on ROCm
RUN pip install https://github.com/ROCm/bitsandbytes/releases/download/rocm_enabled_beta_0.61.0/bitsandbytes-0.61.0+rocm6.0-py3-none-any.whl

WORKDIR /app
EXPOSE 8888 8501
CMD ["tail", "-f", "/dev/null"]</pre>

            <h3 class="text-xl mt-6 mb-2">File 2: docker-compose.yml</h3>
            <p class="mb-2">Handles hardware passthrough and security privileges.</p>
            <pre>services:
  lab:
    build: .
    container_name: rocm-rx7600
    
    # --- HARDWARE ACCESS ---
    privileged: true             
    security_opt:
      - seccomp:unconfined       
    cap_add:
      - SYS_PTRACE               
    
    # Device Mapping
    devices:
      - "/dev/kfd:/dev/kfd"      
      - "/dev/dri:/dev/dri"      
    
    # Group Passthrough
    group_add:
      - video
      - render
    
    ipc: host
    
    volumes:
      - ./workspace:/app
    
    ports:
      - "8888:8888"
      - "8501:8501"
    
    command: tail -f /dev/null</pre>
        </section>

        <section class="mb-10">
            <h2 class="text-2xl text-[#5d5d5d] mb-4 border-b border-[#dcdcdc] pb-2">3. Launching and Verification</h2>
            
            <p class="mb-4"><strong>Start the Lab:</strong></p>
            <pre>docker compose up -d --build
docker exec -it rocm-rx7600 bash</pre>

            <p class="mb-4"><strong>Verify Hardware Visibility:</strong></p>
            <pre>ls -l /dev/kfd
rocm-smi</pre>

            <p class="mb-4"><strong>The Final Test (Python):</strong></p>
            <pre>python3 -c "import torch; print(f'Device: {torch.cuda.get_device_name(0)}'); x = torch.randn(1024, 1024).cuda(); print(x @ x)"</pre>
            <p class="mb-4">Should print the device name and a tensor of numbers without error.</p>
        </section>

        <section class="mb-10">
            <h2 class="text-2xl text-[#5d5d5d] mb-4 border-b border-[#dcdcdc] pb-2">4. Troubleshooting</h2>
            
            <div class="mb-6">
                <h4 class="font-bold mb-1">Issue: GPU: False / No HIP GPUs</h4>
                <p class="mb-2"><em>Cause:</em> Container started before permissions applied or host <code>/dev/kfd</code> blocked.</p>
                <p><em>Fix:</em> Run <code>sudo usermod -aG render $USER</code>. Ensure <code>privileged: true</code> is in compose file. Restart container.</p>
            </div>

            <div class="mb-6">
                <h4 class="font-bold mb-1">Issue: ls: cannot access '/dev/kfd' (Inside container)</h4>
                <p><em>Fix:</em> Ensure <code>security_opt: seccomp:unconfined</code> is in your compose file.</p>
            </div>

            <div class="mb-6">
                <h4 class="font-bold mb-1">Issue: jupyter: command not found</h4>
                <p><em>Fix:</em> Rebuild with <code>docker compose build --no-cache</code>.</p>
            </div>
        </section>

        <div class="text-center mt-12 border-t border-[#dcdcdc] pt-8">
            <a href="#" class="back-link">
                Back to Top
            </a>
        </div>

    </main>

</body>
</html>